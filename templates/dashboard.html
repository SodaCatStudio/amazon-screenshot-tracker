<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Amazon Screenshot Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #232f3e;
        }
        
        /* Flash messages */
        .flash-messages {
            margin-bottom: 20px;
        }
        .flash {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .flash.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .flash.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .flash.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .flash.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .flash-close {
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            opacity: 0.5;
        }
        .flash-close:hover {
            opacity: 1;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #232f3e 0%, #ff9900 100%);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            color: white;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }

        .dashboard-header h1 {
            margin: 0 0 15px 0;
            font-size: 24px;
        }

        .dashboard-header p {
            margin: 0 0 20px 0;
            opacity: 0.9;
        }
        
        /* Button container - ensure it stays within bounds */
        .dashboard-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }

        /* Individual button styling */
        .dashboard-actions .btn {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-sizing: border-box;
            min-width: fit-content;
        }

        .btn-primary {
            background-color: #ff9900;
            color: white;
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .api-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .api-warning a {
            background-color: #ff9900;
            color: white;
            padding: 8px 20px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .product-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .product-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: #232f3e;
        }
        .product-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .rank-display {
            font-size: 24px;
            font-weight: bold;
            color: #ff9900;
            margin: 10px 0;
        }
        .bestseller-badge {
            background-color: #ff9900;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }
        .status-active {
            color: #28a745;
        }
        .status-paused {
            color: #dc3545;
        }
        
        /* Screenshot links section */
        .screenshot-links {
            background-color: #f0f8ff;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid #d0e5ff;
        }
        .screenshot-links-title {
            font-size: 13px;
            font-weight: bold;
            color: #1565c0;
            margin-bottom: 8px;
        }
        .screenshot-link-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .screenshot-link {
            font-size: 13px;
            color: #007bff;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            transition: all 0.2s;
        }
        .screenshot-link:hover {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .screenshot-link.baseline {
            border-color: #6c757d;
            color: #6c757d;
        }
        .screenshot-link.baseline:hover {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }
        .screenshot-link.achievement {
            border-color: #28a745;
            color: #28a745;
        }
        .screenshot-link.achievement:hover {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .screenshots-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .screenshot-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s;
        }
        .screenshot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .screenshot-info {
            padding: 15px;
            background-color: #f8f9fa;
        }
        .target-categories {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .target-category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #bbdefb;
        }
        .target-category-item:last-child {
            border-bottom: none;
        }
        .category-name {
            font-weight: 500;
            color: #1565c0;
        }
        .category-status {
            font-size: 14px;
        }
        .achieved {
            color: #2e7d32;
            font-weight: bold;
        }
        .progress {
            color: #f57c00;
        }
        .add-category-btn {
            background-color: #4caf50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: hidden; /* Prevent body scroll when modal is open */
        }
        .modal-content {
            background-color: white;
            margin: 5vh auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh; /* Limit height to 90% of viewport */
            overflow-y: auto; /* Enable scrolling within modal */
            position: relative;
        }
        /* Custom scrollbar for the modal */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: sticky; /* Make close button sticky */
            top: 0;
            background: white;
            padding: 5px;
            z-index: 1001;
        }
        .close:hover {
            color: black;
        }
        
        /* Image comparison modal */
        .comparison-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            overflow: auto;
        }
        .comparison-content {
            margin: 20px auto;
            padding: 20px;
            width: 90%;
            max-width: 1400px;
        }
        .comparison-header {
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
        .comparison-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .comparison-image-wrapper {
            text-align: center;
        }
        .comparison-image-wrapper h3 {
            color: white;
            margin-bottom: 10px;
        }
        .comparison-image-wrapper img {
            max-width: 100%;
            height: auto;
            border: 2px solid white;
            border-radius: 8px;
        }

        /* Mobile-specific responsive styles */
        @media (max-width: 768px) {
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .dashboard-header {
                padding: 15px;
                margin: 10px;
                border-radius: 8px;
                /* Ensure it doesn't overflow on mobile */
                max-width: calc(100vw - 20px);
                overflow: hidden;
            }

            .dashboard-header h1 {
                font-size: 20px;
                line-height: 1.2;
            }

            .dashboard-header p {
                font-size: 14px;
                margin-bottom: 15px;
            }

            .dashboard-actions {
                /* Stack buttons vertically on small screens */
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .dashboard-actions .btn {
                width: 100%;
                text-align: center;
                padding: 12px 16px;
                font-size: 14px;
                /* Ensure buttons don't overflow */
                max-width: 100%;
                box-sizing: border-box;
            }

            .next-check-widget {
                margin: 10px;
                padding: 15px !important;
            }

            #next-check-list {
                max-height: 200px !important;
            }
        }

        /* Very small mobile screens */
        @media (max-width: 480px) {
            .dashboard-header {
                padding: 12px;
                margin: 5px;
            }

            .dashboard-header h1 {
                font-size: 18px;
            }

            .dashboard-header p {
                font-size: 13px;
            }

            .dashboard-actions .btn {
                padding: 10px 12px;
                font-size: 13px;
            }
        }

        /* Tablet landscape */
        @media (min-width: 769px) and (max-width: 1024px) {
            .dashboard-actions {
                /* Two buttons per row on tablets */
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .dashboard-actions .btn {
                width: 100%;
                text-align: center;
            }
        }

        /* Large screens */
        @media (min-width: 1025px) {
            .dashboard-actions {
                /* Horizontal layout on desktop */
                flex-direction: row;
                justify-content: flex-start;
                flex-wrap: wrap;
            }

            .dashboard-actions .btn {
                width: auto;
                min-width: 120px;
            }
        }

        /* Additional safety measures */
        .container, .main-content {
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
            padding-left: 10px;
            padding-right: 10px;
        }

        /* Ensure the entire page is mobile-friendly */
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Touch device specific improvements */
        .touch-device .btn {
            min-height: 44px; /* iOS recommended touch target */
            touch-action: manipulation; /* Prevent zoom on double tap */
        }

        .touch-device .btn:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        /* Prevent horizontal scroll on mobile */
        html, body {
            overflow-x: hidden;
            width: 100%;
        }

        /* Ensure viewport meta tag is working */
        @viewport {
            width: device-width;
            initial-scale: 1;
        }
    </style>
</head>
<body>
    <!-- CSRF token for JavaScript -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <div class="container">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash {{ category }}">
                            <span>{{ message }}</span>
                            <span class="flash-close" onclick="this.parentElement.style.display='none';">&times;</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <div class="dashboard-header">
            <h1>🏆 Your Amazon Dashboard</h1>
            <p>Welcome back, {{ email }}! Track your products and capture those bestseller moments.</p>

            <!-- Properly contained button group -->
            <div class="dashboard-actions">
                <a href="{{ url_for('add_product_form') }}" class="btn btn-primary">
                    📦 Add New Product
                </a>

                <span class="btn btn-secondary" style="cursor: default;">
                    🤖 Auto-Monitoring Active
                </span>

                <a href="{{ url_for('settings') }}" class="btn btn-info">
                    ⚙️ Settings
                </a>

                <button onclick="showFeedbackModal()" class="btn btn-secondary">
                    💬 Send Feedback
                </button>

                <a href="{{ url_for('auth.logout') }}" class="btn btn-danger">
                    🚪 Logout
                </a>
            </div>
        </div>

        <!-- Show warning if no API key is configured -->
        {% if not has_api_key %}
        <div class="api-warning">
            <div>
                <strong>⚠️ ScrapingBee API Key Required</strong><br>
                You need to add your ScrapingBee API key before you can monitor products.
            </div>
            <a href="{{ url_for('settings') }}">Configure API Key</a>
        </div>
        {% endif %}

        DASHBOARD_TIMER_WIDGET = """
        <div class="next-check-widget" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3>⏰ Next Check Times</h3>
            <div id="next-check-list" style="margin-top: 15px;">
                <p style="color: #666;">Loading check times...</p>
            </div>
        </div>

        <h2>📦 Your Products</h2>
        {% if products %}
        <div class="products-grid">
            {% for product in products %}
            <div class="product-card" id="product-{{ product[0] }}">
                {% if product[4] %}
                <span class="bestseller-badge">🏆 BESTSELLER</span>
                {% endif %}
                
                <div class="product-title">{{ product[1] or 'Product Title Loading...' }}</div>
                
                <div class="product-info">
                    {% if product[2] %}
                    <div class="rank-display">#{{ product[2] }}</div>
                    <div>in {{ product[3] }}</div>
                    {% else %}
                    <div style="color: #999;">Ranking data not yet available</div>
                    {% endif %}
                </div>
                
                <div class="product-info">
                    <div>Status: 
                        {% if product[7] %}
                        <span class="status-active">✅ Active</span>
                        {% else %}
                        <span class="status-paused">⏸️ Paused</span>
                        {% endif %}
                    </div>
                    <div>Last checked: {{ product[5] or 'Never' }}</div>
                    <div>Added: {{ product[6] }}</div>
                </div>

                <!-- Screenshot Links Section -->
                <div class="screenshot-links">
                    <div class="screenshot-links-title">📸 Screenshots:</div>
                    <div class="screenshot-link-row">
                        <a href="{{ url_for('view_baseline_screenshot', product_id=product[0]) }}" 
                           target="_blank" 
                           class="screenshot-link baseline"
                           title="View the initial screenshot when product was first added">
                            📷 Initial Baseline
                        </a>
                        <span id="achievement-count-{{ product[0] }}" style="font-size: 13px; color: #666;">
                            <!-- Achievement count will be loaded via JavaScript -->
                        </span>
                        <a href="javascript:void(0)" 
                           onclick="compareScreenshots({{ product[0] }})"
                           class="screenshot-link"
                           style="border-color: #17a2b8; color: #17a2b8;"
                           title="Compare baseline with latest achievement">
                            🔍 Compare
                        </a>
                    </div>
                </div>

                <!-- Target Categories Section -->
                <div class="target-categories" id="targets-{{ product[0] }}">
                    <h4 style="margin-top: 0;">🎯 Target Categories</h4>
                    <div id="category-list-{{ product[0] }}">
                        <p style="color: #666; font-size: 14px;">Loading categories...</p>
                    </div>
                    <button class="add-category-btn" onclick="showAddCategoryModal({{ product[0] }})">
                        + Add Target Category
                    </button>
                </div>
                
                <div class="actions">
                    {% if product[7] %}
                    <button onclick="toggleMonitoring({{ product[0] }})" class="btn btn-warning">Pause</button>
                    {% else %}
                    <button onclick="toggleMonitoring({{ product[0] }})" class="btn btn-primary">Resume</button>
                    {% endif %}
                    <button onclick="deleteProduct({{ product[0] }})" class="btn btn-danger">Delete</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="background: white; padding: 40px; text-align: center; border-radius: 10px;">
            <p style="color: #666; font-size: 18px;">No products being monitored yet.</p>
            <a href="{{ url_for('add_product_form') }}" class="btn btn-success" style="margin-top: 20px;">Add Your First Product</a>
        </div>
        {% endif %}

        <div class="screenshots-section">
            <h2>🏆 Achievement Screenshots</h2>
            {% if screenshots %}
            <div class="screenshot-grid">
                {% for screenshot in screenshots %}
                <div class="screenshot-card">
                    <a href="/screenshot/{{ screenshot[0] }}" target="_blank">
                        <img src="/screenshot/{{ screenshot[0] }}" alt="Achievement Screenshot" 
                             style="width: 100%; height: 200px; object-fit: cover;">
                    </a>
                    <div class="screenshot-info">
                        <strong>{{ screenshot[1] }}</strong><br>
                        Rank: #{{ screenshot[2] }} in {{ screenshot[3] }}<br>
                        <small>Achieved: {{ screenshot[4] }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="text-align: center; color: #666; padding: 40px;">
                No achievement screenshots yet. Keep monitoring your products!
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Add Target Category</h2>
            <form id="addCategoryForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="modalProductId">
                <div style="margin-bottom: 15px;">
                    <label for="categoryName">Category Name:</label>
                    <input type="text" id="categoryName" required 
                           placeholder="e.g., British Historical Literature"
                           style="width: 100%; padding: 10px; margin-top: 5px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="targetRank">Target Rank (default: 1):</label>
                    <input type="number" id="targetRank" min="1" value="1" 
                           style="width: 100%; padding: 10px; margin-top: 5px;">
                </div>
                <button type="submit" class="btn btn-primary">Add Category</button>
            </form>
        </div>
    </div>

    <!-- Image Comparison Modal -->
    <div id="comparisonModal" class="comparison-modal">
        <div class="comparison-content">
            <span class="close" style="color: white; font-size: 40px; position: absolute; right: 30px; top: 10px;" 
                  onclick="closeComparisonModal()">&times;</span>
            <div class="comparison-header">
                <h2>📊 Screenshot Comparison</h2>
                <p>See how your product ranking has changed over time</p>
            </div>
            <div class="comparison-images">
                <div class="comparison-image-wrapper">
                    <h3>📷 Initial Baseline</h3>
                    <img id="baselineImage" src="" alt="Initial Screenshot">
                </div>
                <div class="comparison-image-wrapper">
                    <h3>🏆 Latest Achievement</h3>
                    <img id="latestImage" src="" alt="Latest Screenshot">
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto; margin: 5vh auto;">
            <span class="close" onclick="closeFeedbackModal()" style="position: sticky; top: 0; float: right; background: white; padding: 5px; z-index: 1001;">&times;</span>
            <h2>📝 Beta Feedback</h2>
            <p>Help us improve Amazon Rank Tracker!</p>

            <form id="feedbackForm" method="POST" action="{{ url_for('send_feedback') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div style="margin-bottom: 15px;">
                    <label>How would you rate your experience? (1-10)</label>
                    <select name="rating" required style="width: 100%; padding: 10px; margin-top: 5px;">
                        <option value="">Select a rating</option>
                        <option value="10">10 - Excellent!</option>
                        <option value="9">9 - Very Good</option>
                        <option value="8">8 - Good</option>
                        <option value="7">7 - Pretty Good</option>
                        <option value="6">6 - Okay</option>
                        <option value="5">5 - Average</option>
                        <option value="4">4 - Below Average</option>
                        <option value="3">3 - Poor</option>
                        <option value="2">2 - Very Poor</option>
                        <option value="1">1 - Terrible</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>What do you love about the app?</label>
                    <textarea name="love" rows="3" 
                              placeholder="Tell us what's working well..."
                              style="width: 100%; padding: 10px; margin-top: 5px;"></textarea>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>What could be improved?</label>
                    <textarea name="improve" rows="3" required
                              placeholder="What would make this better?"
                              style="width: 100%; padding: 10px; margin-top: 5px;"></textarea>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>Any bugs or issues?</label>
                    <textarea name="bugs" rows="3"
                              placeholder="Describe any problems you encountered..."
                              style="width: 100%; padding: 10px; margin-top: 5px;"></textarea>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>Would you pay for this service?</label>
                    <select name="would_pay" required style="width: 100%; padding: 10px; margin-top: 5px;">
                        <option value="">Select an option</option>
                        <option value="yes_now">Yes, I'd pay right now!</option>
                        <option value="yes_improved">Yes, after some improvements</option>
                        <option value="maybe">Maybe, depends on price</option>
                        <option value="no">No, I wouldn't pay</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>If yes, how much per month?</label>
                    <select name="price_point" style="width: 100%; padding: 10px; margin-top: 5px;">
                        <option value="">Select a price</option>
                        <option value="5">$5/month</option>
                        <option value="10">$10/month</option>
                        <option value="15">$15/month</option>
                        <option value="20">$20/month</option>
                        <option value="25+">$25+/month</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                    Send Feedback
                </button>
            </form>
        </div>
    </div>

    <script>
        // Store email globally for use in functions
        const userEmail = "{{ email }}";
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Load target categories and achievement counts for each product
        document.addEventListener('DOMContentLoaded', function() {
            const productCards = document.querySelectorAll('.product-card');
            productCards.forEach(card => {
                const productId = card.id.replace('product-', '');
                if (productId) {
                    loadTargetCategories(productId);
                    loadAchievementCount(productId);
                }
            });
        });

        function loadAchievementCount(productId) {
            // Fetch count of achievement screenshots for this product
            fetch(`/get_achievement_count/${productId}`)
                .then(response => response.json())
                .then(data => {
                    const countElement = document.getElementById(`achievement-count-${productId}`);
                    if (countElement && data.count > 0) {
                        countElement.innerHTML = `
                            <a href="/achievements/${productId}" 
                               class="screenshot-link achievement"
                               title="View all achievement screenshots">
                                🏆 ${data.count} Achievement${data.count > 1 ? 's' : ''}
                            </a>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading achievement count:', error);
                });
        }

        function compareScreenshots(productId) {
            // Open comparison modal with baseline and latest achievement
            const modal = document.getElementById('comparisonModal');
            const baselineImg = document.getElementById('baselineImage');
            const latestImg = document.getElementById('latestImage');

            baselineImg.src = `/baseline_screenshot/${productId}`;

            // Fetch latest achievement screenshot
            fetch(`/latest_achievement/${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.screenshot_id) {
                        latestImg.src = `/screenshot/${data.screenshot_id}`;
                    } else {
                        latestImg.src = '';
                        latestImg.alt = 'No achievements yet';
                    }
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading comparison:', error);
                    alert('Error loading screenshots for comparison');
                });
        }

        function closeComparisonModal() {
            document.getElementById('comparisonModal').style.display = 'none';
        }

        function loadTargetCategories(productId) {
            fetch(`/get_target_categories/${productId}?email=${encodeURIComponent(userEmail)}`)
                .then(response => response.json())
                .then(categories => {
                    const container = document.getElementById(`category-list-${productId}`);
                    if (!container) return;

                    if (categories.length === 0) {
                        container.innerHTML = '<p style="color: #666; font-size: 14px;">No target categories set</p>';
                    } else {
                        container.innerHTML = categories.map(cat => `
                            <div class="target-category-item">
                                <span class="category-name">${cat.category_name}</span>
                                <span class="category-status">
                                    ${cat.is_achieved 
                                        ? `<span class="achieved">✅ Achieved #${cat.best_rank_achieved}</span>`
                                        : cat.best_rank_achieved 
                                            ? `<span class="progress">Best: #${cat.best_rank_achieved} (Target: #${cat.target_rank})</span>`
                                            : `<span style="color: #666;">Target: #${cat.target_rank}</span>`
                                    }
                                </span>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                });
        }

        function showAddCategoryModal(productId) {
            document.getElementById('modalProductId').value = productId;
            document.getElementById('categoryModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('categoryModal').style.display = 'none';
            document.getElementById('addCategoryForm').reset();
        }

        function showFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'block';
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
            document.getElementById('feedbackForm').reset();
        }

        // Handle closing modals when clicking outside - COMBINED handler for all modals
        window.onclick = function(event) {
            // Handle category modal
            const categoryModal = document.getElementById('categoryModal');
            if (event.target == categoryModal) {
                closeModal();
            }

            // Handle feedback modal
            const feedbackModal = document.getElementById('feedbackModal');
            if (event.target == feedbackModal) {
                closeFeedbackModal();
            }

            // Handle comparison modal
            const comparisonModal = document.getElementById('comparisonModal');
            if (event.target == comparisonModal) {
                closeComparisonModal();
            }
        }

        // Add these missing functions for the other operations

        document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const productId = document.getElementById('modalProductId').value;
            const categoryName = document.getElementById('categoryName').value;
            const targetRank = document.getElementById('targetRank').value;

            fetch('/add_target_category', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    product_id: parseInt(productId),
                    category_name: categoryName,
                    target_rank: parseInt(targetRank),
                    email: userEmail
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    closeModal();
                    loadTargetCategories(productId);
                    alert('Target category added successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error adding category: ' + error);
            });
        });

        function toggleMonitoring(productId) {
            if (!confirm('Are you sure you want to toggle monitoring for this product?')) {
                return;
            }

            fetch(`/toggle_monitoring/${productId}?email=${encodeURIComponent(userEmail)}`, {
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                        alert(data.status);
                        location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error toggling monitoring: ' + error);
                });
        }

        function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }

            fetch(`/delete_product/${productId}?email=${encodeURIComponent(userEmail)}`, {
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                        alert('Product deleted successfully!');
                        location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error deleting product: ' + error);
                });
        }

        // Mobile-friendly touch handling
        document.addEventListener('DOMContentLoaded', function() {
            // Add touch-friendly class to buttons on mobile
            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');

                // Add better touch feedback
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.95)';
                    });

                    btn.addEventListener('touchend', function() {
                        this.style.transform = 'scale(1)';
                    });
                });
            }
        });

        function loadNextCheckTimes() {
            fetch('/api/next_check_times')
                .then(response => response.json())
                .then(products => {
                    const container = document.getElementById('next-check-list');

                    if (products.length === 0) {
                        container.innerHTML = '<p style="color: #666;">No products added yet</p>';
                        return;
                    }

                    const html = products.map(product => {
                        let statusBadge = '';
                        let timeText = '';

                        if (product.status === 'paused') {
                            statusBadge = '<span style="color: #dc3545;">⏸️ Paused</span>';
                            timeText = 'Not scheduled';
                        } else if (product.status === 'due') {
                            statusBadge = '<span style="color: #ff9900;">⏳ Checking soon...</span>';
                            timeText = 'Due now';
                        } else if (product.minutes_until_check !== null) {
                            const hours = Math.floor(product.minutes_until_check / 60);
                            const minutes = product.minutes_until_check % 60;

                            if (hours > 0) {
                                timeText = `in ${hours}h ${minutes}m`;
                            } else {
                                timeText = `in ${minutes} minutes`;
                            }

                            statusBadge = '<span style="color: #28a745;">✅ Active</span>';
                        } else {
                            statusBadge = '<span style="color: #6c757d;">🆕 New</span>';
                            timeText = 'First check pending';
                        }

                        return `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${product.title.substring(0, 40)}...</strong><br>
                                    <small style="color: #666;">Next check: ${timeText}</small>
                                </div>
                                <div>${statusBadge}</div>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading check times:', error);
                });
        }

        // Load on page load
        document.addEventListener('DOMContentLoaded', loadNextCheckTimes);

        // Refresh every minute
        setInterval(loadNextCheckTimes, 60000);
    </script>
</body>
</html>